<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoKarts Debug - Multiplayer Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .status-good { color: #4ecdc4; }
        .status-bad { color: #ff6b6b; }
        .status-warning { color: #ffa500; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #4ecdc4;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #45a29e; }
        #log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üèéÔ∏è GoKarts Multiplayer Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Server Connection</h3>
        <p>Status: <span id="connectionStatus" class="status-bad">Disconnected</span></p>
        <p>Player ID: <span id="playerId">None</span></p>
        <p>Player Name: <span id="playerName">None</span></p>
        <p>Room: <span id="roomInfo">Not in room</span></p>
        <p>Game State: <span id="gameState">Unknown</span></p>
        <button onclick="connectToServer()">Connect to Server</button>
        <button onclick="findMatch()">Find Match</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>

    <div class="debug-section">
        <h3>Debugging Checklist</h3>
        <div id="checklist">
            <p>üîç Checking server availability...</p>
        </div>
    </div>

    <div class="debug-section">
        <h3>Live Console Log</h3>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="debug-section">
        <h3>Manual Tests</h3>
        <button onclick="testBotCreation()">Test Bot Creation</button>
        <button onclick="testPositionSync()">Test Position Sync</button>
        <button onclick="window.open('index.html', '_blank')">Open Game in New Tab</button>
    </div>

    <script src="websocket-client.js"></script>
    <script>
        let socket = null;
        let playerId = null;
        let isConnected = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(status, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = className;
        }

        async function updateChecklist() {
            const checklist = document.getElementById('checklist');
            let html = '';
            
            // Check WebSocket client loading
            const clientLoaded = typeof createCloudflareClient !== 'undefined';
            html += `<p>${clientLoaded ? '‚úÖ' : '‚ùå'} WebSocket client loaded: ${clientLoaded}</p>`;
            
            // Test Worker HTTP endpoint
            try {
                const response = await fetch('https://gokarts-multiplayer.stealthbundlebot.workers.dev');
                const workerRunning = response.status === 200;
                html += `<p>${workerRunning ? '‚úÖ' : '‚ùå'} Worker endpoint responding: ${workerRunning}</p>`;
                if (workerRunning) {
                    const text = await response.text();
                    html += `<p class="status-good">üì° Worker says: "${text}"</p>`;
                }
            } catch (error) {
                html += `<p>‚ùå Worker endpoint error: ${error.message}</p>`;
            }
            
            // Check connection
            html += `<p>${isConnected ? '‚úÖ' : '‚ùå'} Connected to Worker: ${isConnected}</p>`;
            
            // Instructions
            if (!clientLoaded) {
                html += `<p class="status-warning">üí° WebSocket client (websocket-client.js) failed to load</p>`;
            }
            
            checklist.innerHTML = html;
        }

        function connectToServer() {
            log('üåê Attempting to connect to Cloudflare Worker...');
            
            if (socket) {
                socket.disconnect();
            }
            
            if (typeof createCloudflareClient === 'undefined') {
                log('‚ùå WebSocket client not loaded!');
                updateStatus('Client Error', 'status-bad');
                return;
            }
            
            socket = createCloudflareClient();
            log('‚úÖ Created Cloudflare client');
            
            socket.on('connect', () => {
                isConnected = true;
                playerId = socket.id;
                log(`‚úÖ Connected! Player ID: ${playerId}`);
                updateStatus('Connected', 'status-good');
                document.getElementById('playerId').textContent = playerId;
                updateChecklist();
            });
            
            socket.on('disconnect', () => {
                isConnected = false;
                log('‚ùå Disconnected from server');
                updateStatus('Disconnected', 'status-bad');
                document.getElementById('playerId').textContent = 'None';
                document.getElementById('roomInfo').textContent = 'Not in room';
                updateChecklist();
            });
            
            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error}`);
                updateStatus('Connection Error', 'status-bad');
                updateChecklist();
            });
            
            socket.on('room-update', (data) => {
                log(`üè† Room update: ${data.playersCount}/${data.maxPlayers} players`);
                document.getElementById('roomInfo').textContent = `${data.playersCount}/${data.maxPlayers} players`;
                if (data.players && data.players.length > 0) {
                    log(`üë• Players in room: ${data.players.map(p => p.name).join(', ')}`);
                }
            });
            
            socket.on('race-start', (data) => {
                log(`üèÅ Race starting with ${data.players.length} players:`);
                data.players.forEach(p => {
                    log(`  - ${p.name} (${p.isBot ? 'Bot' : 'Human'})`);
                });
            });
            
            socket.on('player-position', (data) => {
                if (Math.random() < 0.1) { // Log 10% of position updates
                    log(`üìç Position update: ${data.playerId.substr(0, 8)}... at (${data.x.toFixed(2)}, ${data.y.toFixed(2)})`);
                }
            });
            
            // Actually connect to the Worker
            const workerUrl = 'wss://gokarts-multiplayer.stealthbundlebot.workers.dev';
            log(`üîó Connecting to: ${workerUrl}`);
            socket.connect(workerUrl);
        }

        function findMatch() {
            if (!socket || !isConnected) {
                log('‚ùå Not connected to server');
                return;
            }
            
            const playerName = `DebugPlayer_${Date.now().toString().slice(-4)}`;
            log(`üîç Looking for match as ${playerName}...`);
            document.getElementById('playerName').textContent = playerName;
            
            socket.emit('player-identify', {
                name: playerName,
                wallet: null
            });
            socket.emit('find-match');
        }

        function leaveRoom() {
            if (!socket || !isConnected) {
                log('‚ùå Not connected to server');
                return;
            }
            
            log('üö™ Leaving room...');
            socket.emit('leave-room');
            document.getElementById('roomInfo').textContent = 'Not in room';
        }

        function testBotCreation() {
            log('ü§ñ Testing bot creation - start a match to see bots in action');
            findMatch();
        }

        function testPositionSync() {
            if (!socket || !isConnected) {
                log('‚ùå Not connected to server');
                return;
            }
            
            log('üì° Testing position synchronization...');
            // Simulate position updates
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    socket.emit('player-update', {
                        x: Math.random(),
                        y: Math.random(),
                        angle: Math.random() * Math.PI * 2,
                        lapCount: 1,
                        nextCheckpoint: 0,
                        speed: Math.random() * 5
                    });
                    log(`üì§ Sent position update ${i + 1}/5`);
                }, i * 200);
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Initialize
        updateChecklist();
        
        // Auto-connect to Cloudflare Worker
        setTimeout(connectToServer, 1000);
    </script>
</body>
</html>